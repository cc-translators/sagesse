\ProvidesPackage{sagesse}
\newcommand*{\@dv@numberlines}{0}
\DeclareOption{numberlines}{\renewcommand{\@dv@numberlines}{1}}
\let\@dv@chapterpages\@empty
\newif\if@dv@chapterpages
\DeclareOption{chapterpages}{\@dv@chapterpagestrue}
\let\@dv@nochecksec\@empty
\DeclareOption{noseccheck}{\def\@dv@nochecksec{true}}
\ProcessOptions

% HRule
\newcommand{\HRule}{\rule{\linewidth}{0.2mm}}

% Title display in HTML
\newcommand{\HTMLchapHook}[1]{}
\newcommand{\HTMLsecHook}[2]{}

\newcommand\subtitleskip{\\[0.4em]}

% Book title
\newcommand{\booktitle}[3]{%
\textsc{\large#1}
\\[1.5cm]
\HRule \\[0.4cm]
\textsc{\Huge#2}\\[0.4cm]

\HRule \\[1.5cm]
{\LARGE#3}\\[1.5cm]
}

% Intro signature
\newcommand{\signature}[1]{%
\vspace{1cm}\parbox{4in}{\raggedleft{\large\emph{#1}}}
}

% Package scrpage2 for headers
\usepackage{scrpage2}

% colon, frenchb's definition
\newcommand\frcolon{%
      \ifhmode
        \ifdim\lastskip>\z@
          \unskip\penalty\@M\Fcolonspace
        \else
          \FDP@colonspace
        \fi
      \fi
      \string:\space}

% setting lettrines
\usepackage{type1cm} % scalable fonts
\usepackage{lettrine}
\usepackage{xcolor}
\usepackage{ifluatex}

% Wrapper for TeX4HT
\newcommand{\Og}{\og}
\newcommand{\Fg}{\fg{}}

% fonts
\ifluatex
\usepackage{fontspec}
\usepackage{xunicode}
%\defaultfontfeatures{Mapping=tex-text}
\defaultfontfeatures{Ligatures=TeX}
%\setmainfont{Minion Pro}
\setmainfont{EB Garamond}
\newfontfamily\smallfont[Scale=0.99]{EB Garamond}
\newfontfamily\ssmallfont[Scale=0.98]{EB Garamond}
\newfontfamily\sssmallfont[Scale=0.97]{EB Garamond}
%\setmainfont[Numbers=OldStyle]{Linux Libertine O}
%\newfontfamily\dayheadfont[Scale=1.1,LetterSpace=0.8]{Goudy Trajan}
%\newfontfamily\dayheadfont[Scale=2.9]{Goldwater}
%\newfontfamily\dayheadfont[Scale=2.5,LetterSpace=2]{Latino Elongated LET}
%\newfontfamily\dayheadfont[Scale=1.6]{Nimbus Sans L Regular Condensed}
%\newfontfamily\dayheadfont[Scale=1.3]{DejaVu Sans Condensed}
%\newfontfamily\dayheadfont[Scale=1.2]{DejaVu Serif Condensed}
%\newfontfamily\dayheadfont[Scale=1,LetterSpace=0.2]{Charlemagne Std}
%\newfontfamily\dayheadfont[Scale=1.7]{SF Covington Cond}
%\newfontfamily\dayheadfont[Scale=1.7]{SF Covington SC Cond}
%\newfontfamily\dayheadfont[Scale=2.2]{ModernTypOgraphy}
%\newfontfamily\dayheadfont[Scale=1.5]{Gladifilthefte}
%\newfontfamily\dayheadfont[Scale=1.8]{Six Caps}
%\newfontfamily\dayheadfont[Scale=1.8]{Grov Condensed}
%\newfontfamily\dayheadfont[Scale=1.8]{WinterthurCondensed}
%\newfontfamily\dayheadfont[Scale=1.4]{Myriad Pro}
%\newfontfamily\dayheadfont[Scale=1.4]{Minion Pro}
%\newfontfamily\dayheadfont[Scale=1.6]{Minion Pro Semibold Cond Display}
%\newfontfamily\dayheadfont[Scale=1.5,Letters=SmallCaps]{Minion Pro Semibold Cond Display}
%\newfontfamily\dayheadfont[Scale=1.8]{Minion Pro Cond Display}
%\newfontfamily\dayheadfont[Scale=1.6,Letters=SmallCaps]{Minion Pro Cond Display}
%\newfontfamily\dayheadfont[Scale=1.6]{Garamond Book Condensed SSi}
\newfontfamily\dayheadfont[Scale=1.35,Letters=SmallCaps]{EB Garamond}
%\newfontfamily\dayheadfont[Scale=1.5,Letters=SmallCaps]{EBGaramond08-SC}
%\newfontfamily\dayheadfont[Scale=1.6,Letters=SmallCaps]{EB Garamond Condensed}
%\newfontfamily\dayheadfont[Scale=1.7]{GarmdITC BkCn BT}
%\newfontfamily\dayheadfont[Scale=1.7]{Garamond Premier Pro Bold Display}
%\newfontfamily\dayheadfont[Scale=1.3,Letters=SmallCaps]{Garamond Premier Pro Bold Display}
%\newfontfamily\dayheadfont[Scale=1.7]{Garamond Premier Pro Semibold Display}
%\newfontfamily\dayheadfont[Scale=1.3,Letters=SmallCaps]{Garamond Premier Pro Semibold Display}
%\newfontfamily\dayheadfont[Scale=2]{Bodoni MT Condensed}
%\newfontfamily\monthheadfont[Scale=5,LetterSpace=2]{Latino Elongated LET}
\newfontfamily\monthheadfont[Scale=5,LetterSpace=2]{EB Garamond}
%\newfontfamily\dayheadfont[Scale=2.5,Letters=SmallCaps]{[LatinoElongatedLetPlainSC.otf]}
%\newfontfamily\monthheadfont[Scale=2.5,Letters=SmallCaps]{[LatinoElongatedLetPlainSC.otf]}
%\newfontfamily\lettrinefont{Caslon Initials}
\else
\newcommand\smallfont{}
\newcommand\ssmallfont{}
\newcommand\sssmallfont{}
\newcommand\dayheadfont{}
\newcommand\monthheadfont{}
\fi

% Tune chapter headings
\usepackage{titlesec}
\usepackage{fancytabs}
\usepackage{fancybox}
\usepackage{fourier-orns}

\usepackage{ragged2e}

% Use ifpdf to generate ebook
\usepackage{ifpdf}

% Make day number in month, in french
\usepackage{ifthen}

% Define \chaphead to be used in section headings
\let\oldchapter\chapter
\newcommand\temphead{}
\newcommand\chaphead{}
\renewcommand\chapter[2][\temphead]{%
    \renewcommand\temphead{#2}%
    \renewcommand\chaphead{#2}%
    \oldchapter[#1]{#2}}

% Note du traducteur
\newcommand{\NdT}[1]{\footnote{NdT\frcolon #1}}
% Use footnote package when footnotes (or NdT)
% are called from within \dvquote
% Warning:Load footnote after xcolor
\usepackage{footnote}

% Lettrines
\renewcommand{\LettrineFontHook}{\color[gray]{0.6}}

% Number lines
\makeatletter
\ifthenelse{\@dv@numberlines=1}{
  \usepackage{lineno}%
  \pagewiselinenumbers
}

\newcommand{\stoplinenumbers}{%
  \ifthenelse{\@dv@numberlines=1}%
    {\nolinenumbers}{}%
}

\newcommand{\startlinenumbers}{%
  \ifthenelse{\@dv@numberlines=1}%
    {\linenumbers}{}%
}

\newcommand{\setinternallinenumbers}[1]{%
  \ifthenelse{\@dv@numberlines=1}%
    {%
     \internallinenumbers%
     \renewcommand{\thelinenumber}{#1\arabic{linenumber}}%
     \resetlinenumber%
    }{}
}

% Lengths for boxes
\newlength{\outparbox}%
\newlength{\inparbox}%
\newlength{\vspaceparbox}%

% opening quote
\newcommand{\dvquote}[3][0.9\textwidth]{%
  \stoplinenumbers%
  \setlength{\outparbox}{#1}%
  \setlength{\vspaceparbox}{-0.07\inparbox}%
  \vfill
  \begin{center}\parbox{\outparbox}{%
    \begin{Center}%
    \hyphenpenalty=10000%
    \setinternallinenumbers{q}%
    \begin{itshape}#2\end{itshape}\\[1.2mm]
    \ocadr{}\textsc{#3}%
    \end{Center}%
  }\end{center}\vspace{\vspaceparbox}%
  \vfill
  \startlinenumbers%
}


% justify or center
\newsavebox{\@justcentbox}%
\newcommand{\justifyorcenter}[1]{%
  \sbox \@justcentbox{#1}%
  \ifdim \wd \@justcentbox >\hsize #1%
  \else \centerline{\usebox{\@justcentbox}} \fi
}

% central quote, generic
\newcommand{\dvboxgeneric}[2][0.9\textwidth]{%
  \stoplinenumbers%
  \setlength{\outparbox}{#1}%
  \setlength{\inparbox}{0.9\outparbox}%
  \setlength{\vspaceparbox}{0.03\inparbox}%
  \vfill
  \begin{center}\doublebox{%
    \parbox{\outparbox}{%
      \vspace{\vspaceparbox}%
        \begin{Center}%
          \@raggedtwoe@spaceskipfalse%
          \@raggedtwoe@everyselectfont%
          \parbox{\inparbox}{%
            \setinternallinenumbers{b}%
            \hyphenpenalty=1000%
            #2%
          }%
        \end{Center}%
      \vspace{\vspaceparbox}%
    }%
  }\end{center}%
  \vfill
  \startlinenumbers%
}

% justifyorcenter
\newcommand{\dvbox}[2][0.9\textwidth]{%
  \dvboxgeneric[#1]{%
    \justifyorcenter{\large\textsc{#2}}%
  }%
}

% no justifyorcenter, required for enumerate
\newcommand{\dvboxnocenter}[2][0.9\textwidth]{%
  \dvboxgeneric[#1]{%
    \large\textsc{#2}%
  }%
}

% ending prayer
\newcommand{\dvprayer}[3][0.8\textwidth]{
  \stoplinenumbers%
  \begin{center}\parbox{#1}{%
    \ifthenelse{\@dv@numberlines=1}%
      {\nolinenumbers}{}%
    \begin{Center}%
    \hyphenpenalty=10000%
    \setinternallinenumbers{p}%
    \begin{itshape}#2\end{itshape}\\[1.2mm]
    \scshape#3%
    \end{Center}%
  }\end{center}
  \startlinenumbers%
}
\makeatother


\usepackage{pifont}
\usepackage{graphicx}
% Minion ornaments, see MinionPro.pdf, page 6
\newcommand{\rightrule}{\Pisymbol{MinionPro-Extra}{121}}
\newcommand{\leftrule}{\reflectbox{\rightrule}}
\newcommand{\diamondone}{\Pisymbol{MinionPro-Extra}{119}}

% Rule sep
\newcommand{\dvrule}[1][0pt]{%
%  \vspace{#1}
  \vfill
  \begin{center}%
%\fontspec[Scale=5]{Davys}5
%    \leftrule~~\floweroneleft\floweroneright~~\rightrule
%\includegraphics[width=10em]{rule_square_long}
\fontspec[Scale=9]{HoodHeavenOrnamentsTwoSSi}\char"0050%
  \end{center}%
  \vspace{-6mm}
  \vfill
}


% Dans le Nom de Jésus, Amen.
\newcommand{\Amen}{Amen.}
\newcommand{\DlNdJ}{Dans le Nom de J\'esus, \Amen}
\newcommand{\DlNdJnp}{Dans le Nom de J\'esus, nous prions, \Amen}
\newcommand{\NpDlNdJ}{Nous prions dans le Nom de J\'esus. \Amen}
\newcommand{\NpDlpNdJ}{Nous prions dans le pr\'ecieux Nom de Jésus. \Amen}
\newcommand{\CDlNdJqnp}{C'est dans le Nom de J\'esus que nous prions, \Amen}
\newcommand{\EsN}{En Son Nom, nous prions, \Amen}
\newcommand{\ESN}{En Son Nom, \Amen}
\newcommand{\CeSNqnp}{C'est en Son Nom que nous prions, \Amen}
\newcommand{\DlPNdJ}{Dans le Pr\'ecieux Nom de Jésus, \Amen}
\newcommand{\NlddlNdJ}{Nous le demandons dans le Nom de J\'esus, \Amen}
\newcommand{\NpcdlNdJ}{Nous prions ceci dans le Nom de J\'esus, \Amen}

% YHWH
\newcommand{\Seigneur}{\textsc{Seigneur}}


% cadratin
\newcommand*{\ocadr}{\mbox{---}\nobreak\,\nobreak}
\newcommand*{\fcadr}{\unskip\nobreak\,\nobreak{}---}

% demi-cadratin
\newcommand*{\odcadr}{\mbox{--}\nobreak\thinspace\nobreak}
\newcommand*{\fdcadr}{\unskip\nobreak\thinspace\nobreak{}--}

% King James Fran\c{c}aise
\newcommand{\KJF}{\ocadr{}\emph{Version King James Fran\c{c}aise}}
\newcommand{\NKJF}{\ocadr{}\emph{Version Nouvelle King James Fran\c{c}aise}}
% Bible en Fran\c{c}ais Courant
\newcommand{\BFC}{\ocadr{}\emph{Version de la Bible en Fran\c{c}ais Courant}}
\newcommand{\NKJV}{\ocadr{}\emph{Version NKJV}}
\newcommand{\NBS}{\ocadr{}\emph{Version Nouvelle Bible Segond}}
\newcommand{\PDV}{\ocadr{}\emph{Version Parole de Vie}}

% L' doesn't look good in titles with Minion... Fix that
\newcommand{\ap}{\kern.5pt{'}}

% How to format dates
\usepackage{moredatetime}
\let\dvformatdate\formatdateny

% Page date
\newcommand{\pagedate}{%
  \dvformatdate{\thesection}{\thedvmonth}{0}%
}

\newcommand{\setpagedate}[1]{%
  \expandafter\gdef\csname pagedate\thepage\endcsname{#1}%
}

\newcommand{\getpagedate}[1]{%
  \csname pagedate#1\endcsname
}

\usepackage{etoolbox}
\newcommand{\transform}[1]{
  \def\secondparam{0}%
  \forcsvlist\decodesec{#1}}
\newcommand{\decodesec}[1]{%
  \ifthenelse{\secondparam=1}{, }{}%
  \hyperlink{page.#1}{\mbox{\textsc{\getpagedate{#1}}}}%
  \def\secondparam{1}}
\renewcommand*{\bvidxpgformat}{transform}

% Patch bibleref to sort Bible books properly
\makeatletter
\patchcmd{\@bible@verse}{\@bv@idxsort{\csname br@#1\endcsname}}{\@bv@idxsort{#1}}
\makeatother

%\usepackage{mfirstuc}

% Need to wrap to make \noexpand work
\newcommand{\mapmonthname}[1]{%
\monthname[#1]%
}

\newcommand{\dvcurmonth}{%
  \mapmonthname{\thedvmonth}%
}

\newenvironment{devotional}%
{%
% Counter to test that pages do not overflow
\newcounter{pageoverflow}%
\setcounter{pageoverflow}{\thepage}%
\addtocounter{pageoverflow}{-1}%
% Reset chapter counter for tabs
%\setcounter{chapter}{0}
\pagestyle{empty}
\renewcommand*{\partpagestyle}{empty}
\renewcommand*{\chapterpagestyle}{empty}
% Record the starting chapter of the devotional
\newcounter{dvstartchapter}
\setcounter{dvstartchapter}{\arabic{chapter}}
\newcounter{dvmonth}

% Define useful aliases
\newcommand{\dvmonth}{%
  \ifx\@dv@nochecksec\@empty
    \addtocounter{pageoverflow}{2}%
    \ifthenelse{\arabic{pageoverflow}<\thepage}{%
      \GenericError{}{Section longer than one page before page \thepage!}{}{}%
    }{}%
  \fi
  \setcounter{pageoverflow}{\thepage}%
  \addtocounter{pageoverflow}{1}%
  \stepcounter{dvmonth}%
  \HTMLchapHook{\dvcurmonth}%
  \if@dv@chapterpages
  \chapter{\dvcurmonth}%
    \cleardoublepage%
  \else
    \renewcommand\chaphead{\dvcurmonth}%
    \refstepcounter{chapter}%
    \@maybeautodot\thechapter
    \addchaptertocentry{\thechapter}{\dvcurmonth}%
  \fi
}

% Index day counter

\newcommand{\dvday}[2][\normalfont]{\newpage\section{##2}%
\expandafter\xdef\csname pagedate\thepage\endcsname{%
  \noexpand\dvformatdate{\thesection}{\thedvmonth}{0}% expand \thesection and \thedvmonth, transform to date later
}%
\HTMLsecHook{\dvformatdate{\thesection}{\thedvmonth}{0}}{##2}%
\ifx\@dv@nochecksec\@empty
  \addtocounter{pageoverflow}{1}%
  \ifthenelse{\arabic{pageoverflow}=\thepage}{}{%
    \GenericError{}{Section longer than one page before page \thepage!}{}{}%
  }%
\fi
##1%
}


% Set chapter pages
\titleformat{\chapter}[block]
  {\vfill\monthheadfont}
  {}{10pt}
  {\filcenter}
  [\vfill\vfill]

% Set paragraphs
\setlength{\parindent}{0em}

% Tune section headings and use tabs
% I'd like that to go inside the devotional environment
\fancytabsHeight{1.2in}
% WITHOUT BLEED
% 6*1.2 + 2*0.6 + 5*0.12 = 9
%\fancytabsTop{0.6in}
%\fancytabsGap{0.12in}
% WITH BLEED
% 6*1.2 + 2*0.725 + 5*0.12 = 9.25
\fancytabsTop{0.725in}
\fancytabsGap{0.12in}

% WITHOUT BLEED
% \fancytabsWidth{0.40in}
% WITH BLEED
% Add 0.125 for the bleed
\fancytabsWidth{0.525in}
% Put text more inside
% (0.4/2)/0.525 = 0.38
\fancytabsTextVPos{0.5}
\fancytabsTextHPos{0.38}

% Set floor for tabs based on starting chapter
\fancytabsFloor{\thedvstartchapter}

% Set tabs text style
% The original version uses uppercase
%\fancytabsStyle{\Large\MakeUppercase}
\fancytabsStyle{\normalfont\LARGE\scshape}

\renewcommand\thesection{\arabic{section}}
% Make a different style to use in CSS
\newcommand\titlestrut{\vrule height 25pt width0pt\relax}
\newcommand{\secstyle}{\filcenter\dayheadfont\huge}
\newcommand{\seclbl}{\raggedright\normalfont\scshape\Large\pagedate\\}

\titleformat{\section}[display]
  {\secstyle} % format
  {\seclbl} % label
  {-15pt} %sep
  {
  \ifthenelse{\isodd{\thepage}}%
    {\fancytab{\chaphead}{\arabic{chapter}}}%
    {}%
  \titlestrut\filcenter} %before
\titlespacing{\section}{0pt}{*}{-3pt}

} % end of \begin{devotional}
{} % end of \end{devotional}


% Define dummy caltoc, only for ebooks
\newcommand\caltoc{}

