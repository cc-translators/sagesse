\ProvidesPackage{devotional}
\newcommand*{\@dv@numberlines}{0}
\DeclareOption{numberlines}{\renewcommand{\@dv@numberlines}{1}}
\let\@dv@nochecksec\@empty
\DeclareOption{noseccheck}{\def\@dv@nochecksec{true}}
\ProcessOptions

% Package scrpage2 for headers
\usepackage{scrpage2}

% setting lettrines
\usepackage{type1cm} % scalable fonts
\usepackage{lettrine}
\usepackage{xcolor}

% Tune chapter headings
\usepackage{titlesec}
\usepackage{fancytabs}
\usepackage{fancybox}
\usepackage{fourier-orns}

\usepackage{ragged2e}

% Use ifpdf to generate ebook
\usepackage{ifpdf}

% Make day number in month, in french
\usepackage{ifthen}
\newcommand{\makedate}[1]{
  \ifthenelse{\equal{#1}{1}}{1\up{er}}{%
    \ifthenelse{\equal{#1}{0}}{}{#1}}
}

% Define \chaphead to be used in section headings
\let\oldchapter\chapter
\newcommand\temphead{}
\newcommand\chaphead{}
\renewcommand\chapter[2][\temphead]{%
    \renewcommand\temphead{#2}%
    \renewcommand\chaphead{#2}%
    \oldchapter[#1]{#2}}

% Note du traducteur
\newcommand{\NdT}[1]{\footnote{NdT~: #1}}
% Use footnote package when footnotes (or NdT)
% are called from within \dvquote
% Warning:Load footnote after xcolor
\usepackage{footnote}

% Lettrines
\renewcommand{\LettrineFontHook}{\color[gray]{0.6}}

% Number lines
\makeatletter
\ifthenelse{\@dv@numberlines=1}{
  \usepackage{lineno}%
  \pagewiselinenumbers
}

\newcommand{\stoplinenumbers}{%
  \ifthenelse{\@dv@numberlines=1}%
    {\nolinenumbers}{}%
}

\newcommand{\startlinenumbers}{%
  \ifthenelse{\@dv@numberlines=1}%
    {\linenumbers}{}%
}

\newcommand{\setinternallinenumbers}[1]{%
  \ifthenelse{\@dv@numberlines=1}%
    {%
     \internallinenumbers%
     \renewcommand{\thelinenumber}{#1\arabic{linenumber}}%
     \resetlinenumber%
    }{}
}

% opening quote
\newcommand{\dvquote}[2]{%
  \stoplinenumbers%
  \begin{center}\parbox{110mm}{%
    \begin{Center}%
    \hyphenpenalty=10000%
    \setinternallinenumbers{q}%
    \begin{itshape}#1\end{itshape}\\[1.2mm]
    \ocadr{}\textsc{#2}%
    \end{Center}%
  }\end{center}\vspace{-5mm}%
  \startlinenumbers%
}


% justify or center
\newsavebox{\@justcentbox}%
\newcommand{\justifyorcenter}[1]{%
  \sbox \@justcentbox{#1}%
  \ifdim \wd \@justcentbox >\hsize #1%
  \else \centerline{\usebox{\@justcentbox}} \fi
}

% central quote
\newcommand{\dvbox}[2][]{%
  \stoplinenumbers%
  \begin{center}\doublebox{%
    \parbox{10cm}{%
      \vspace{3mm}%
        \begin{Center}%
          \@raggedtwoe@spaceskipfalse%
          \@raggedtwoe@everyselectfont%
          \parbox{9cm}{%
            \setinternallinenumbers{b}%
            \hyphenpenalty=1000%
            \justifyorcenter{#1\large\textsc{#2}}%
          }%
        \end{Center}%
      \vspace{3mm}%
    }%
  }\end{center}%
  \startlinenumbers%
}

% ending prayer
\newcommand{\dvprayer}[2]{
  \stoplinenumbers%
  \begin{center}\parbox{4in}{%
    \ifthenelse{\@dv@numberlines=1}%
      {\nolinenumbers}{}%
    \begin{Center}%
    \hyphenpenalty=10000%
    \setinternallinenumbers{p}%
    \begin{itshape}#1\end{itshape}\\[1.2mm]
    \scshape#2%
    \end{Center}%
  }\end{center}
  \startlinenumbers%
}
\makeatother


\usepackage{pifont}
\usepackage{graphicx}
% Minion ornaments, see MinionPro.pdf, page 6
\newcommand{\rightrule}{\Pisymbol{MinionPro-Extra}{121}}
\newcommand{\leftrule}{\reflectbox{\rightrule}}
\newcommand{\diamondone}{\Pisymbol{MinionPro-Extra}{119}}

% Rule sep
\newcommand{\dvrule}{%
  \begin{center}%
    \ifpdf
      \leftrule~~\floweroneleft\floweroneright~~\rightrule
    \else
      \rule{5cm}{.3pt}
    \fi
  \end{center}%
}


% Dans le Nom de Jésus, Amen.
\newcommand{\Amen}{Amen.}
\newcommand{\DlNdJ}{Dans le Nom de Jésus, \Amen}
\newcommand{\DlNdJnp}{Dans le Nom de Jésus, nous prions, \Amen}
\newcommand{\NpDlNdJ}{Nous prions dans le Nom de Jésus. \Amen}
\newcommand{\CDlNdJqnp}{C'est dans le Nom de Jésus que nous prions, \Amen}
\newcommand{\EsN}{En Son Nom, nous prions, \Amen}
\newcommand{\ESN}{En Son Nom, \Amen}
\newcommand{\CeSNqnp}{C'est en Son Nom que nous prions, \Amen}
\newcommand{\DlPNdJ}{Dans le Précieux Nom de Jésus, \Amen}
\newcommand{\NlddlNdJ}{Nous le demandons dans le Nom de Jésus, \Amen}
\newcommand{\NpcdlNdJ}{Nous prions ceci dans le Nom de Jésus, \Amen}

% YHWH
\newcommand{\Seigneur}{\textsc{Seigneur}}


% cadratin
\newcommand*{\ocadr}{\mbox{---}\nobreak\,\nobreak}
\newcommand*{\fcadr}{\unskip\nobreak\,\nobreak{}---}

% demi-cadratin
\newcommand*{\odcadr}{\mbox{--}\nobreak\thinspace\nobreak}
\newcommand*{\fdcadr}{\unskip\nobreak\thinspace\nobreak{}--}

% King James Française
\newcommand{\KJF}{\ocadr{}\emph{Version King James Française}}
\newcommand{\NKJF}{\ocadr{}\emph{Version Nouvelle King James Française}}
% Bible en Français Courant
\newcommand{\BFC}{\ocadr{}\emph{Version de la Bible en Français Courant}}
\newcommand{\NKJV}{\ocadr{}\emph{Version NKJV}}
\newcommand{\NBS}{\ocadr{}\emph{Version Nouvelle Bible Segond}}
\newcommand{\PDV}{\ocadr{}\emph{Version Parole de Vie}}

% L' doesn't look good in titles with Minion... Fix that
\newcommand{\ap}{\kern.5pt{'}}

% Page date
\newcommand{\pagedate}{%
  \makedate{\thesection}~\chaphead
}

\newcommand{\setpagedate}[1]{%
  \expandafter\gdef\csname pagedate\thepage\endcsname{#1}%
}

\newcommand{\getpagedate}[1]{%
  \csname pagedate#1\endcsname
}

\usepackage{etoolbox}
\newcommand{\transform}[1]{
  \def\secondparam{0}%
  \forcsvlist\decodesec{#1}}
\newcommand{\decodesec}[1]{%
  \ifthenelse{\secondparam=1}{, }{}%
  \hyperlink{page.#1}{\mbox{\scshape\getpagedate{#1}}}%
  \def\secondparam{1}}
\renewcommand*{\bvidxpgformat}{transform}


\newenvironment{devotional}%
{%
% Counter to test that pages do not overflow
\newcounter{pageoverflow}%
\setcounter{pageoverflow}{\thepage}%
\addtocounter{pageoverflow}{-1}%
% Reset chapter counter for tabs
%\setcounter{chapter}{0}
\pagestyle{empty}
\renewcommand*{\partpagestyle}{empty}
\renewcommand*{\chapterpagestyle}{empty}
% Record the starting chapter of the devotional
\newcounter{dvstartchapter}
\setcounter{dvstartchapter}{\arabic{chapter}}

% Define useful aliases
\newcommand{\dvmonth}[1]{%
  \ifx\@dv@nochecksec\@empty
    \addtocounter{pageoverflow}{2}%
    \ifthenelse{\arabic{pageoverflow}<\thepage}{%
      \GenericError{}{Section longer than one page before page \thepage!}{}{}%
    }{}%
  \fi
  \chapter{##1}%
  \setcounter{pageoverflow}{\thepage}%
  \addtocounter{pageoverflow}{1}%
  \cleardoublepage%
}

% Index day counter

\newcommand{\dvday}[1]{\newpage\section{##1}%
  \expandafter\xdef\csname pagedate\thepage\endcsname{\noexpand\makedate{\thesection}~\chaphead}%
  \ifx\@dv@nochecksec\@empty
    \addtocounter{pageoverflow}{1}%
    \ifthenelse{\arabic{pageoverflow}=\thepage}{}{%
      \GenericError{}{Section longer than one page before page \thepage!}{}{}%
    }%
  \fi
}


% Set chapter pages
\titleformat{\chapter}[block]
  {\vfill\scshape\fontsize{40}{35}}
  {}{10pt}
  {\filcenter\textls[-50]}
  [\vfill\vfill]

% Set paragraphs
\setlength{\parindent}{0mm}

% Tune section headings and use tabs
% I'd like that to go inside the devotional environment
\fancytabsHeight{1.2in}
% WITHOUT BLEED
% 6*1.2 + 2*0.6 + 5*0.12 = 9
%\fancytabsTop{0.6in}
%\fancytabsGap{0.12in}
% WITH BLEED
% 6*1.2 + 2*0.725 + 5*0.12 = 9.25
\fancytabsTop{0.725in}
\fancytabsGap{0.12in}

% WITHOUT BLEED
% \fancytabsWidth{0.40in}
% WITH BLEED
% Add 0.125 for the bleed
\fancytabsWidth{0.525in}
% Put text more inside
% (0.4/2)/0.525 = 0.38
\fancytabsTextVPos{0.5}
\fancytabsTextHPos{0.38}

% Set floor for tabs based on starting chapter
\fancytabsFloor{\thedvstartchapter}

% Set tabs text style
% The original version uses uppercase
%\fancytabsStyle{\Large\MakeUppercase}
\fancytabsStyle{\LARGE\scshape}

\renewcommand\thesection{\arabic{section}}
\ifpdf
  \newcommand{\secstyle}{\scshape\fontsize{32}{30}}
  \newcommand{\seclbl}{\scshape\Large\pagedate}
\else
  % Make a different style to use in CSS
  \newcommand{\secstyle}{\filcenter\Huge\bfseries\scshape}
  \newcommand{\seclbl}{\scshape\Large\pagedate\\}
\fi
\titleformat{\section}[display]
  {\secstyle} % format
  {\vspace{20mm}\seclbl} % label
  {10pt} %sep
  {
  \ifthenelse{\isodd{\thepage}}%
    {\fancytab{\chaphead}{\arabic{chapter}}}%
    {}%
  \filcenter\textls[-50]
  } %before
\titlespacing{\section}{0pt}{*}{*}

} % end of \begin{devotional}
{} % end of \end{devotional}



