\ProvidesPackage{devotional}
\newcommand*{\@dv@numberlines}{0}
\DeclareOption{numberlines}{\renewcommand{\@dv@numberlines}{1}}
\let\@dv@chapterpages\@empty
\newif\if@dv@chapterpages
\DeclareOption{chapterpages}{\@dv@chapterpagestrue}
\let\@dv@nochecksec\@empty
\DeclareOption{noseccheck}{\def\@dv@nochecksec{true}}
\ProcessOptions

% Package scrpage2 for headers
\usepackage{scrpage2}

% setting lettrines
\usepackage{type1cm} % scalable fonts
\usepackage{lettrine}
\usepackage{xcolor}

% fonts
\usepackage{fontspec}
\usepackage{xunicode}
\defaultfontfeatures{Mapping=tex-text}
%\setmainfont{Minion Pro}
\setmainfont{EB Garamond}
\newfontfamily\smallfont[Scale=0.99]{EB Garamond}
\newfontfamily\ssmallfont[Scale=0.98]{EB Garamond}
\newfontfamily\sssmallfont[Scale=0.97]{EB Garamond}
%\setmainfont[Numbers=OldStyle]{Linux Libertine O}
%\newfontfamily\dayheadfont[Scale=1.1,LetterSpace=0.8]{Goudy Trajan}
%\newfontfamily\dayheadfont[Scale=2.5,LetterSpace=2]{Goldwater}
\newfontfamily\dayheadfont[Scale=2.5,LetterSpace=2]{Latino Elongated LET}
\newfontfamily\monthheadfont[Scale=5,LetterSpace=2]{Latino Elongated LET}
%\newfontfamily\dayheadfont[Scale=2.5,Letters=SmallCaps]{[LatinoElongatedLetPlainSC.otf]}
%\newfontfamily\monthheadfont[Scale=2.5,Letters=SmallCaps]{[LatinoElongatedLetPlainSC.otf]}

% Tune chapter headings
\usepackage{titlesec}
\usepackage{fancytabs}
\usepackage{fancybox}
\usepackage{fourier-orns}

\usepackage{ragged2e}

% Use ifpdf to generate ebook
\usepackage{ifpdf}

% Make day number in month, in french
\usepackage{ifthen}
\newcommand{\makedate}[1]{
  \ifthenelse{\equal{#1}{1}}{1\up{er}}{%
    \ifthenelse{\equal{#1}{0}}{}{#1}}
}

% Define \chaphead to be used in section headings
\let\oldchapter\chapter
\newcommand\temphead{}
\newcommand\chaphead{}
\renewcommand\chapter[2][\temphead]{%
    \renewcommand\temphead{#2}%
    \renewcommand\chaphead{#2}%
    \oldchapter[#1]{#2}}

% Note du traducteur
\newcommand{\NdT}[1]{\footnote{NdT~: #1}}
% Use footnote package when footnotes (or NdT)
% are called from within \dvquote
% Warning:Load footnote after xcolor
\usepackage{footnote}

% Lettrines
\renewcommand{\LettrineFontHook}{\color[gray]{0.6}}

% Number lines
\makeatletter
\ifthenelse{\@dv@numberlines=1}{
  \usepackage{lineno}%
  \pagewiselinenumbers
}

\newcommand{\stoplinenumbers}{%
  \ifthenelse{\@dv@numberlines=1}%
    {\nolinenumbers}{}%
}

\newcommand{\startlinenumbers}{%
  \ifthenelse{\@dv@numberlines=1}%
    {\linenumbers}{}%
}

\newcommand{\setinternallinenumbers}[1]{%
  \ifthenelse{\@dv@numberlines=1}%
    {%
     \internallinenumbers%
     \renewcommand{\thelinenumber}{#1\arabic{linenumber}}%
     \resetlinenumber%
    }{}
}

% Lengths for boxes
\newlength{\outparbox}%
\newlength{\inparbox}%
\newlength{\vspaceparbox}%

% opening quote
\newcommand{\dvquote}[3][0.9\textwidth]{%
  \stoplinenumbers%
  \setlength{\outparbox}{#1}%
  \setlength{\vspaceparbox}{-0.07\inparbox}%
  \begin{center}\parbox{\outparbox}{%
    \begin{Center}%
    \hyphenpenalty=10000%
    \setinternallinenumbers{q}%
    \begin{itshape}#2\end{itshape}\\[1.2mm]
    \ocadr{}\textsc{#3}%
    \end{Center}%
  }\end{center}\vspace{\vspaceparbox}%
  \startlinenumbers%
}


% justify or center
\newsavebox{\@justcentbox}%
\newcommand{\justifyorcenter}[1]{%
  \sbox \@justcentbox{#1}%
  \ifdim \wd \@justcentbox >\hsize #1%
  \else \centerline{\usebox{\@justcentbox}} \fi
}

% central quote
\newcommand{\dvbox}[2][0.9\textwidth]{%
  \stoplinenumbers%
  \setlength{\outparbox}{#1}%
  \setlength{\inparbox}{0.9\outparbox}%
  \setlength{\vspaceparbox}{0.03\inparbox}%
  \begin{center}\doublebox{%
    \parbox{\outparbox}{%
      \vspace{\vspaceparbox}%
        \begin{Center}%
          \@raggedtwoe@spaceskipfalse%
          \@raggedtwoe@everyselectfont%
          \parbox{\inparbox}{%
            \setinternallinenumbers{b}%
            \hyphenpenalty=1000%
            \justifyorcenter{\large\textsc{#2}}%
          }%
        \end{Center}%
      \vspace{\vspaceparbox}%
    }%
  }\end{center}%
  \startlinenumbers%
}

% ending prayer
\newcommand{\dvprayer}[3][0.8\textwidth]{
  \stoplinenumbers%
  \begin{center}\parbox{#1}{%
    \ifthenelse{\@dv@numberlines=1}%
      {\nolinenumbers}{}%
    \begin{Center}%
    \hyphenpenalty=10000%
    \setinternallinenumbers{p}%
    \begin{itshape}#2\end{itshape}\\[1.2mm]
    \scshape#3%
    \end{Center}%
  }\end{center}
  \startlinenumbers%
}
\makeatother


\usepackage{pifont}
\usepackage{graphicx}
% Minion ornaments, see MinionPro.pdf, page 6
\newcommand{\rightrule}{\Pisymbol{MinionPro-Extra}{121}}
\newcommand{\leftrule}{\reflectbox{\rightrule}}
\newcommand{\diamondone}{\Pisymbol{MinionPro-Extra}{119}}

% Rule sep
\newcommand{\dvrule}[1][0pt]{%
%  \vspace{#1}
  \begin{center}%
\fontspec[Scale=5]{Davys}5
%    \leftrule~~\floweroneleft\floweroneright~~\rightrule
%\includegraphics[width=10em]{rule_square_long}
  \end{center}%
  \vspace{-12mm}
}


% Dans le Nom de Jésus, Amen.
\newcommand{\Amen}{Amen.}
\newcommand{\DlNdJ}{Dans le Nom de Jésus, \Amen}
\newcommand{\DlNdJnp}{Dans le Nom de Jésus, nous prions, \Amen}
\newcommand{\NpDlNdJ}{Nous prions dans le Nom de Jésus. \Amen}
\newcommand{\CDlNdJqnp}{C'est dans le Nom de Jésus que nous prions, \Amen}
\newcommand{\EsN}{En Son Nom, nous prions, \Amen}
\newcommand{\ESN}{En Son Nom, \Amen}
\newcommand{\CeSNqnp}{C'est en Son Nom que nous prions, \Amen}
\newcommand{\DlPNdJ}{Dans le Précieux Nom de Jésus, \Amen}
\newcommand{\NlddlNdJ}{Nous le demandons dans le Nom de Jésus, \Amen}
\newcommand{\NpcdlNdJ}{Nous prions ceci dans le Nom de Jésus, \Amen}

% YHWH
\newcommand{\Seigneur}{\textsc{Seigneur}}


% cadratin
\newcommand*{\ocadr}{\mbox{---}\nobreak\,\nobreak}
\newcommand*{\fcadr}{\unskip\nobreak\,\nobreak{}---}

% demi-cadratin
\newcommand*{\odcadr}{\mbox{--}\nobreak\thinspace\nobreak}
\newcommand*{\fdcadr}{\unskip\nobreak\thinspace\nobreak{}--}

% King James Française
\newcommand{\KJF}{\ocadr{}\emph{Version King James Française}}
\newcommand{\NKJF}{\ocadr{}\emph{Version Nouvelle King James Française}}
% Bible en Français Courant
\newcommand{\BFC}{\ocadr{}\emph{Version de la Bible en Français Courant}}
\newcommand{\NKJV}{\ocadr{}\emph{Version NKJV}}
\newcommand{\NBS}{\ocadr{}\emph{Version Nouvelle Bible Segond}}
\newcommand{\PDV}{\ocadr{}\emph{Version Parole de Vie}}

% L' doesn't look good in titles with Minion... Fix that
\newcommand{\ap}{\kern.5pt{'}}

% Page date
\newcommand{\pagedate}{%
  \makedate{\thesection}~\chaphead
}

\newcommand{\setpagedate}[1]{%
  \expandafter\gdef\csname pagedate\thepage\endcsname{#1}%
}

\newcommand{\getpagedate}[1]{%
  \csname pagedate#1\endcsname
}

\usepackage{etoolbox}
\newcommand{\transform}[1]{
  \def\secondparam{0}%
  \forcsvlist\decodesec{#1}}
\newcommand{\decodesec}[1]{%
  \ifthenelse{\secondparam=1}{, }{}%
  \hyperlink{page.#1}{\mbox{\scshape\getpagedate{#1}}}%
  \def\secondparam{1}}
\renewcommand*{\bvidxpgformat}{transform}

% Patch bibleref to sort Bible books properly
\makeatletter
\patchcmd{\@bible@verse}{\@bv@idxsort{\csname br@#1\endcsname}}{\@bv@idxsort{#1}}
\makeatother


\newenvironment{devotional}%
{%
% Counter to test that pages do not overflow
\newcounter{pageoverflow}%
\setcounter{pageoverflow}{\thepage}%
\addtocounter{pageoverflow}{-1}%
% Reset chapter counter for tabs
%\setcounter{chapter}{0}
\pagestyle{empty}
\renewcommand*{\partpagestyle}{empty}
\renewcommand*{\chapterpagestyle}{empty}
% Record the starting chapter of the devotional
\newcounter{dvstartchapter}
\setcounter{dvstartchapter}{\arabic{chapter}}

% Define useful aliases
\newcommand{\dvmonth}[1]{%
  \ifx\@dv@nochecksec\@empty
    \addtocounter{pageoverflow}{2}%
    \ifthenelse{\arabic{pageoverflow}<\thepage}{%
      \GenericError{}{Section longer than one page before page \thepage!}{}{}%
    }{}%
  \fi
  \setcounter{pageoverflow}{\thepage}%
  \addtocounter{pageoverflow}{1}%
  \if@dv@chapterpages
    \chapter{##1}%
    \cleardoublepage%
  \else
    \renewcommand\chaphead{##1}%
    \setcounter{section}{0}%
    \addtocounter{chapter}{1}%
    \addcontentsline{toc}{chapter}{##1}%
  \fi
}

% Index day counter

\newcommand{\dvday}[2][\normalfont]{\newpage\section{##2}%
  \expandafter\xdef\csname pagedate\thepage\endcsname{\noexpand\makedate{\thesection}~\chaphead}%
  \ifx\@dv@nochecksec\@empty
    \addtocounter{pageoverflow}{1}%
    \ifthenelse{\arabic{pageoverflow}=\thepage}{}{%
      \GenericError{}{Section longer than one page before page \thepage!}{}{}%
    }%
  \fi
  ##1%
}


% Set chapter pages
\titleformat{\chapter}[block]
  {\vfill\monthheadfont}
  {}{10pt}
  {\filcenter}
  [\vfill\vfill]

% Set paragraphs
\setlength{\parindent}{0mm}

% Tune section headings and use tabs
% I'd like that to go inside the devotional environment
\fancytabsHeight{1.2in}
% WITHOUT BLEED
% 6*1.2 + 2*0.6 + 5*0.12 = 9
%\fancytabsTop{0.6in}
%\fancytabsGap{0.12in}
% WITH BLEED
% 6*1.2 + 2*0.725 + 5*0.12 = 9.25
\fancytabsTop{0.725in}
\fancytabsGap{0.12in}

% WITHOUT BLEED
% \fancytabsWidth{0.40in}
% WITH BLEED
% Add 0.125 for the bleed
\fancytabsWidth{0.525in}
% Put text more inside
% (0.4/2)/0.525 = 0.38
\fancytabsTextVPos{0.5}
\fancytabsTextHPos{0.38}

% Set floor for tabs based on starting chapter
\fancytabsFloor{\thedvstartchapter}

% Set tabs text style
% The original version uses uppercase
%\fancytabsStyle{\Large\MakeUppercase}
\fancytabsStyle{\normalfont\LARGE\scshape}

\renewcommand\thesection{\arabic{section}}
% Make a different style to use in CSS
\newcommand{\secstyle}{\filcenter\dayheadfont\huge}
\newcommand{\seclbl}{\raggedright\normalfont\scshape\Large\pagedate\\}
\
\titleformat{\section}[display]
  {\secstyle} % format
  {\seclbl} % label
  {-7pt} %sep
  {
  \ifthenelse{\isodd{\thepage}}%
    {\fancytab{\chaphead}{\arabic{chapter}}}%
    {}%
  \filcenter} %before
\titlespacing{\section}{0pt}{*}{-3pt}

} % end of \begin{devotional}
{} % end of \end{devotional}



